<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <title>FinanÃ§as Mobile â€” Dashboard</title>
  <style>
    :root{
      --bg0:#070a14;
      --bg1:#0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --good:#38d996;
      --bad:#ff5c7a;
      --warn:#ffd166;
      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 10% 10%, rgba(120,90,255,.22), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(50,210,255,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(255,130,200,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* estrelas fake (leve, sem imagem) */
    .stars{
      position:fixed; inset:0; pointer-events:none; opacity:.55;
      background-image:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.9) 50%, transparent 51%),
        radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,.7) 50%, transparent 51%),
        radial-gradient(1px 1px at 70% 30%, rgba(255,255,255,.8) 50%, transparent 51%),
        radial-gradient(1px 1px at 85% 75%, rgba(255,255,255,.6) 50%, transparent 51%),
        radial-gradient(1px 1px at 55% 55%, rgba(255,255,255,.7) 50%, transparent 51%),
        radial-gradient(1px 1px at 15% 55%, rgba(255,255,255,.55) 50%, transparent 51%),
        radial-gradient(1px 1px at 95% 45%, rgba(255,255,255,.55) 50%, transparent 51%);
      background-size: 340px 340px;
      filter: drop-shadow(0 0 6px rgba(255,255,255,.18));
      animation: twinkle 10s linear infinite;
    }
    @keyframes twinkle{
      0%{ transform:translateY(0); opacity:.52; }
      50%{ transform:translateY(-6px); opacity:.62; }
      100%{ transform:translateY(0); opacity:.52; }
    }

    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(11,16,32,.78), rgba(11,16,32,.35));
      border-bottom: 1px solid var(--stroke);
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 14px 16px; }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand h1{
      font-size: 16px; margin:0; letter-spacing:.2px;
    }
    .brand p{
      margin:0; font-size:12px; color:var(--muted);
    }
    .seg{
      display:flex; gap:8px; align-items:center;
    }
    select, input, button{
      font:inherit;
    }
    select, input{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
    }
    select:focus, input:focus{
      border-color: rgba(170,140,255,.55);
      box-shadow: 0 0 0 4px rgba(170,140,255,.12);
    }
    button{
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      transition: transform .08s ease, border-color .12s ease;
    }
    button:active{ transform: translateY(1px) scale(.99); }
    .primary{
      border-color: rgba(160,140,255,.55);
      background: linear-gradient(180deg, rgba(160,140,255,.32), rgba(255,255,255,.08));
    }
    .danger{
      border-color: rgba(255,92,122,.55);
      background: linear-gradient(180deg, rgba(255,92,122,.28), rgba(255,255,255,.06));
    }

    main .wrap{ padding-top: 16px; padding-bottom: 90px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 880px){
      .grid{ grid-template-columns: 1.2fr .8fr; gap: 14px; }
    }

    .card{
      background: linear-gradient(180deg, var(--card2), var(--card));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(500px 200px at 10% 0%, rgba(160,140,255,.18), transparent 60%),
                  radial-gradient(420px 160px at 90% 0%, rgba(50,210,255,.14), transparent 65%);
      pointer-events:none;
    }
    .card > .inner{ position:relative; padding: 14px; }
    .title{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      margin-bottom: 10px;
    }
    .title h2{ margin:0; font-size: 14px; letter-spacing:.25px; }
    .title small{ color:var(--muted); font-size: 12px; }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (min-width: 520px){
      .kpis{ grid-template-columns: 1fr 1fr 1fr; }
    }
    .kpi{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .kpi .label{ color:var(--muted); font-size: 11px; }
    .kpi .value{ font-weight: 700; font-size: 16px; margin-top: 6px; }
    .kpi .sub{ color:var(--muted); font-size: 11px; margin-top: 6px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .row3{ grid-template-columns: 1fr; }
    }
    .full{ grid-column: 1 / -1; }

    .hint{ color:var(--muted); font-size: 12px; line-height:1.35; }

    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow:hidden;
    }
    .table th, .table td{
      text-align:left;
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      vertical-align: top;
      word-break: break-word;
    }
    .table th{ color: var(--muted); font-weight: 600; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }
    .pill.good{ border-color: rgba(56,217,150,.35); color: rgba(56,217,150,.9); }
    .pill.bad{ border-color: rgba(255,92,122,.35); color: rgba(255,92,122,.92); }

    .footerbar{
      position:fixed; left:0; right:0; bottom:0; z-index:12;
      background: linear-gradient(180deg, rgba(11,16,32,0), rgba(11,16,32,.88));
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
    }
    .footerbar .wrap{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      gap:10px;
    }
    .footerbar button{ flex:1; padding: 12px; border-radius: 16px; }
    .muted-link{ color: var(--muted); text-decoration: none; }
    .muted-link:hover{ text-decoration: underline; }

    canvas{ width:100%; height: 160px; background: rgba(0,0,0,.10); border-radius: 16px; border:1px solid rgba(255,255,255,.08); }
  </style>
</head>

<body>
  <div class="stars"></div>

  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <h1>ðŸ’« FinanÃ§as Mobile</h1>
          <p>Dashboard offline â€¢ salva no aparelho</p>
        </div>

        <div class="seg">
          <select id="monthSelect" aria-label="MÃªs"></select>
          <button id="exportBtn" title="Exportar dados (.json)">Exportar</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid">
        <!-- DASHBOARD -->
        <section class="card">
          <div class="inner">
            <div class="title">
              <h2>ðŸ“Š Dashboard do mÃªs</h2>
              <small id="monthLabel"></small>
            </div>

            <div class="kpis">
              <div class="kpi">
                <div class="label">Saldo do mÃªs</div>
                <div class="value" id="kpiSaldo">R$ 0,00</div>
                <div class="sub" id="kpiSaldoSub">Receitas âˆ’ Despesas</div>
              </div>
              <div class="kpi">
                <div class="label">Receitas</div>
                <div class="value" id="kpiReceitas">R$ 0,00</div>
                <div class="sub" id="kpiReceitasSub">Total no mÃªs</div>
              </div>
              <div class="kpi">
                <div class="label">Despesas</div>
                <div class="value" id="kpiDespesas">R$ 0,00</div>
                <div class="sub" id="kpiDespesasSub">Total no mÃªs</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="title">
              <h2>âœ¨ Despesas por categoria</h2>
              <small class="hint">Top 6 (mÃªs)</small>
            </div>
            <canvas id="chart"></canvas>

            <div style="height:12px"></div>
            <div id="topCats" class="hint"></div>
          </div>
        </section>

        <!-- LANÃ‡AMENTO -->
        <section class="card">
          <div class="inner">
            <div class="title">
              <h2>âž• LanÃ§ar transaÃ§Ã£o</h2>
              <small class="hint">mobile-first</small>
            </div>

            <div class="row">
              <div class="full">
                <input id="desc" placeholder="DescriÃ§Ã£o (ex.: Mercado, SalÃ¡rio...)" />
              </div>

              <div>
                <input id="value" type="number" step="0.01" inputmode="decimal" placeholder="Valor (ex.: 39.90)" />
              </div>

              <div>
                <select id="type">
                  <option value="despesa">Despesa</option>
                  <option value="receita">Receita</option>
                </select>
              </div>

              <div>
                <select id="category"></select>
              </div>

              <div>
                <select id="account">
                  <option>CartÃ£o</option>
                  <option>Pix</option>
                  <option>Dinheiro</option>
                  <option>Banco</option>
                </select>
              </div>

              <div>
                <input id="date" type="date" />
              </div>

              <div class="full">
                <button class="primary" id="addBtn">Salvar transaÃ§Ã£o</button>
              </div>
            </div>

            <div style="height:14px"></div>

            <div class="title">
              <h2>ðŸ§¾ Ãšltimas transaÃ§Ãµes</h2>
              <small class="hint">toque para excluir</small>
            </div>

            <div style="overflow:auto">
              <table class="table" id="txTable">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>DescriÃ§Ã£o</th>
                    <th>Categoria</th>
                    <th>Valor</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div style="height:10px"></div>
            <div class="hint">
              Dica: no celular, adicione Ã  tela inicial para ficar com cara de app.
            </div>

            <div style="height:10px"></div>
            <button class="danger" id="resetBtn">Zerar tudo</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <div class="footerbar">
    <div class="wrap">
      <button class="primary" id="quickExpense">+ Despesa rÃ¡pida</button>
      <button id="quickIncome">+ Receita rÃ¡pida</button>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "financas_mobile_v1";

  const defaultCategories = [
    "AlimentaÃ§Ã£o","Moradia","Transporte","SaÃºde","EducaÃ§Ã£o","Lazer","Assinaturas","Compras","Impostos","Outros"
  ];

  /** @type {{ transactions: Array<{id:string, date:string, desc:string, value:number, type:"receita"|"despesa", category:string, account:string}> }} */
  let state = loadState();

  // Elements
  const monthSelect = document.getElementById("monthSelect");
  const monthLabel = document.getElementById("monthLabel");
  const exportBtn = document.getElementById("exportBtn");

  const descEl = document.getElementById("desc");
  const valueEl = document.getElementById("value");
  const typeEl = document.getElementById("type");
  const categoryEl = document.getElementById("category");
  const accountEl = document.getElementById("account");
  const dateEl = document.getElementById("date");
  const addBtn = document.getElementById("addBtn");
  const resetBtn = document.getElementById("resetBtn");

  const quickExpense = document.getElementById("quickExpense");
  const quickIncome = document.getElementById("quickIncome");

  const kpiSaldo = document.getElementById("kpiSaldo");
  const kpiReceitas = document.getElementById("kpiReceitas");
  const kpiDespesas = document.getElementById("kpiDespesas");

  const txTableBody = document.querySelector("#txTable tbody");
  const chart = document.getElementById("chart");
  const topCats = document.getElementById("topCats");

  // Init
  initDateDefaults();
  initCategories();
  initMonthPicker();
  render();

  // Events
  addBtn.addEventListener("click", () => addTransaction());
  resetBtn.addEventListener("click", () => {
    if (!confirm("Tem certeza que quer zerar tudo?")) return;
    state = { transactions: [] };
    saveState();
    initMonthPicker();
    render();
  });

  exportBtn.addEventListener("click", exportData);

  quickExpense.addEventListener("click", () => {
    typeEl.value = "despesa";
    descEl.focus();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });
  quickIncome.addEventListener("click", () => {
    typeEl.value = "receita";
    descEl.focus();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  monthSelect.addEventListener("change", render);

  function initDateDefaults(){
    const today = new Date();
    dateEl.value = toISODate(today);
  }

  function initCategories(){
    categoryEl.innerHTML = "";
    for (const c of defaultCategories){
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      categoryEl.appendChild(opt);
    }
  }

  function initMonthPicker(){
    const months = getMonthsFromState(state.transactions);
    monthSelect.innerHTML = "";
    for (const m of months){
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      monthSelect.appendChild(opt);
    }
    // default selected: current month if exists, else latest
    const cur = currentMonthKey();
    if (months.includes(cur)) monthSelect.value = cur;
    else monthSelect.value = months[0] || cur;
  }

  function addTransaction(){
    const desc = (descEl.value || "").trim();
    const value = Number(valueEl.value);
    const type = typeEl.value;
    const category = categoryEl.value;
    const account = accountEl.value;
    const date = dateEl.value;

    if (!desc) return toast("Coloca uma descriÃ§Ã£o ðŸ™‚");
    if (!date) return toast("Escolhe uma data");
    if (!Number.isFinite(value) || value <= 0) return toast("Valor invÃ¡lido");

    const tx = {
      id: cryptoRandomId(),
      date,
      desc,
      value: round2(value),
      type,
      category,
      account
    };
    state.transactions.unshift(tx); // latest first
    saveState();
    // Reset minimal
    descEl.value = "";
    valueEl.value = "";
    typeEl.value = "despesa";
    categoryEl.value = category;
    accountEl.value = account;
    dateEl.value = date;

    initMonthPicker();
    render();
    toast("Salvo âœ…");
  }

  function deleteTransaction(id){
    state.transactions = state.transactions.filter(t => t.id !== id);
    saveState();
    initMonthPicker();
    render();
    toast("ExcluÃ­do");
  }

  function render(){
    const monthKey = monthSelect.value || currentMonthKey();
    monthLabel.textContent = monthKey;

    const txMonth = state.transactions.filter(t => monthFromDate(t.date) === monthKey);

    const receitas = sum(txMonth.filter(t => t.type === "receita").map(t => t.value));
    const despesas = sum(txMonth.filter(t => t.type === "despesa").map(t => t.value));
    const saldo = receitas - despesas;

    kpiReceitas.textContent = brl(receitas);
    kpiDespesas.textContent = brl(despesas);
    kpiSaldo.textContent = brl(saldo);
    kpiSaldo.style.color = saldo >= 0 ? "rgba(56,217,150,.95)" : "rgba(255,92,122,.95)";

    renderTable(txMonth.slice(0, 12));
    renderCategoriesChart(txMonth);
  }

  function renderTable(list){
    txTableBody.innerHTML = "";
    if (list.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" style="color:rgba(255,255,255,.55); padding:14px 8px;">
        Sem lanÃ§amentos no mÃªs. Bora comeÃ§ar ðŸ‘‡
      </td>`;
      txTableBody.appendChild(tr);
      return;
    }

    for (const t of list){
      const tr = document.createElement("tr");
      const pillClass = t.type === "receita" ? "good" : "bad";
      const sign = t.type === "receita" ? "+" : "âˆ’";
      tr.innerHTML = `
        <td>${formatBRDate(t.date)}</td>
        <td>${escapeHtml(t.desc)}<div class="pill">${escapeHtml(t.account)}</div></td>
        <td>${escapeHtml(t.category)}</td>
        <td>
          <span class="pill ${pillClass}">${sign} ${brl(t.value)}</span>
        </td>
      `;
      tr.style.cursor = "pointer";
      tr.title = "Toque para excluir";
      tr.addEventListener("click", () => {
        if (confirm(`Excluir "${t.desc}" (${brl(t.value)})?`)) deleteTransaction(t.id);
      });
      txTableBody.appendChild(tr);
    }
  }

  function renderCategoriesChart(txMonth){
    const byCat = new Map();
    for (const t of txMonth){
      if (t.type !== "despesa") continue;
      byCat.set(t.category, (byCat.get(t.category) || 0) + t.value);
    }
    const sorted = [...byCat.entries()].sort((a,b) => b[1]-a[1]).slice(0, 6);

    // textual top cats
    if (sorted.length === 0){
      topCats.textContent = "Sem despesas no mÃªs ainda. âœ¨";
    } else {
      topCats.innerHTML = sorted.map(([c,v]) => `â€¢ <b>${escapeHtml(c)}</b>: ${brl(v)}`).join("<br/>");
    }

    // draw chart (simple bar chart)
    const ctx = chart.getContext("2d");
    const w = chart.width = chart.clientWidth * devicePixelRatio();
    const h = chart.height = chart.clientHeight * devicePixelRatio();
    ctx.clearRect(0,0,w,h);

    // background glow
    const g = ctx.createLinearGradient(0,0,w,h);
    g.addColorStop(0, "rgba(160,140,255,.10)");
    g.addColorStop(1, "rgba(50,210,255,.06)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    const pad = 18 * devicePixelRatio();
    const innerW = w - pad*2;
    const innerH = h - pad*2;

    // axes baseline
    ctx.strokeStyle = "rgba(255,255,255,.12)";
    ctx.lineWidth = 1 * devicePixelRatio();
    ctx.beginPath();
    ctx.moveTo(pad, pad + innerH);
    ctx.lineTo(pad + innerW, pad + innerH);
    ctx.stroke();

    if (sorted.length === 0) return;

    const maxV = Math.max(...sorted.map(x => x[1])) || 1;
    const gap = 10 * devicePixelRatio();
    const barW = (innerW - gap*(sorted.length-1)) / sorted.length;

    sorted.forEach(([cat,val], i) => {
      const x = pad + i*(barW+gap);
      const barH = (val / maxV) * (innerH * 0.88);
      const y = pad + innerH - barH;

      // bar gradient (fake 3D)
      const bg = ctx.createLinearGra
